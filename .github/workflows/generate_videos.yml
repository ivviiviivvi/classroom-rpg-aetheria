name: Generate Portfolio Videos

on:
  workflow_dispatch:
    inputs:
      script_pattern:
        description: 'Script file pattern to process'
        required: false
        default: '*SCRIPT*.md'
      video_resolution:
        description: 'Video resolution'
        required: false
        default: '1920x1080'
      fps:
        description: 'Frames per second'
        required: false
        default: '30'
  push:
    paths:
      - 'satellites/portfolio/PORTFOLIO_VIDEO_SCRIPT.md'
      - 'satellites/**/*SCRIPT*.md'
      - 'satellites/video-production/video_production_agent.py'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-videos:
    name: Generate Portfolio Videos
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            espeak \
            espeak-data \
            libespeak-dev \
            fonts-dejavu-core \
            fonts-dejavu-extra
          
          # Verify installations
          ffmpeg -version
          espeak --version
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      - name: Configure video production
        run: |
          echo "REPO_ROOT=${{ github.workspace }}" >> $GITHUB_ENV
          echo "SCRIPT_DIR=${{ github.workspace }}/satellites/portfolio" >> $GITHUB_ENV
          echo "SCRIPT_PATTERN=${{ github.event.inputs.script_pattern || '*SCRIPT*.md' }}" >> $GITHUB_ENV
          echo "VIDEO_OUT_DIR=${{ github.workspace }}/video_output" >> $GITHUB_ENV
          echo "VOICE_MODE=local_tts" >> $GITHUB_ENV
          echo "VIDEO_RESOLUTION=${{ github.event.inputs.video_resolution || '1920x1080' }}" >> $GITHUB_ENV
          echo "FPS=${{ github.event.inputs.fps || '30' }}" >> $GITHUB_ENV
          echo "LLM_MODE=local_llm" >> $GITHUB_ENV
          echo "HEADLESS=true" >> $GITHUB_ENV
      
      - name: Run video production agent
        run: |
          python satellites/video-production/video_production_agent.py
      
      - name: List generated videos
        run: |
          echo "Generated videos:"
          ls -lh video_output/*.mp4 || echo "No MP4 files found"
          
          echo ""
          echo "Generated logs:"
          ls -lh video_output/*.log.txt || echo "No log files found"
          
          echo ""
          echo "Video output directory structure:"
          find video_output/ -type f -o -type d | sort
      
      - name: Upload video artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: portfolio-videos-${{ github.sha }}
          path: |
            video_output/*.mp4
            video_output/*.log.txt
            video_production.log
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload intermediate assets
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: video-assets-${{ github.sha }}
          path: |
            video_output/audio/
            video_output/visuals/
          retention-days: 7
          if-no-files-found: warn
      
      - name: Create video summary
        if: always()
        run: |
          echo "## Video Production Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d video_output ]; then
            VIDEO_COUNT=$(find video_output -name "*.mp4" -type f | wc -l)
            echo "- **Videos Generated:** $VIDEO_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ $VIDEO_COUNT -gt 0 ]; then
              echo "### Generated Videos" >> $GITHUB_STEP_SUMMARY
              for video in video_output/*.mp4; do
                if [ -f "$video" ]; then
                  SIZE=$(du -h "$video" | cut -f1)
                  NAME=$(basename "$video")
                  echo "- üìπ \`$NAME\` ($SIZE)" >> $GITHUB_STEP_SUMMARY
                fi
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -f video_production.log ]; then
              echo "### Production Log" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -50 video_production.log >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ùå No video output directory found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Comment on PR with video info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment = '## üé¨ Portfolio Videos Generated\n\n';
            
            const videoDir = 'video_output';
            if (fs.existsSync(videoDir)) {
              const videos = fs.readdirSync(videoDir).filter(f => f.endsWith('.mp4'));
              
              if (videos.length > 0) {
                comment += `Generated ${videos.length} video(s):\n\n`;
                videos.forEach(video => {
                  const stats = fs.statSync(path.join(videoDir, video));
                  const sizeMB = (stats.size / (1024 * 1024)).toFixed(2);
                  comment += `- üìπ \`${video}\` (${sizeMB} MB)\n`;
                });
                comment += '\n';
                comment += 'Download artifacts from the workflow run to view the videos.\n';
              } else {
                comment += '‚ö†Ô∏è No videos were generated. Check the workflow logs for details.\n';
              }
            } else {
              comment += '‚ùå Video output directory not found.\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
